#!/bin/bash

# Default file paths
CONVERSATION_FILE="/tmp/ivim_conversation_$(date "+%Y%m%d%H%M%S").json"
VERBOSITY=0

# Logging function
log() {
  local level="$1"
  local message="$2"
  local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
  case "$level" in
    DEBUG)
      [[ $VERBOSITY -ge 3 ]] && echo "$timestamp [DEBUG] $message"
      ;;
    INFO)
      [[ $VERBOSITY -ge 2 ]] && echo "$timestamp [INFO] $message"
      ;;
    WARN)
      [[ $VERBOSITY -ge 1 ]] && echo "$timestamp [WARN] $message"
      ;;
    ERROR)
      echo "$timestamp [ERROR] $message"
      ;;
    *)
      echo "$timestamp [UNKNOWN] Unknown log level: $level"
      ;;
  esac
}

# Help message
show_help() {
  cat << EOF
Usage: ivim [options]
Options:
  -h        Show help message.
  -v        Increase verbosity of log messages.
  -f FILE   Specify a conversation file.
EOF
}

# Main interaction loop
interact() {
  log INFO "Interaction loop started."
  while true; do
    echo "Provide your command (type 'exit' to quit):"
    read -r user_input
    log INFO "User input: $user_input"
    if [[ "$user_input" == "exit" ]]; then
      log INFO "User requested to exit."
      break
    fi

    log DEBUG "Passing user input to commandrouter."
    command_output=$(echo "$user_input" | xargs commandrouter)
    log DEBUG "Commandrouter output: $command_output"
    
    if [[ "$command_output" != "unknown" ]]; then
      log DEBUG "Making command output editable using editbuf."
      edited_command_output=$(echo "$command_output" | xargs editbuf)
      log DEBUG "Edited command output: $edited_command_output"
      
      log DEBUG "Passing edited command output to actionhandler."
      action_output=$(echo "$edited_command_output" | xargs actionhandler)
      log DEBUG "Actionhandler output: $action_output"
      
      log INFO "Updating conversation with action output."
      convoupdater "$CONVERSATION_FILE" "assistant" "$action_output"
    else
      log ERROR "Unknown command: $user_input"
    fi

    log DEBUG "Fetching response from brainbridge."
    conversation_json=$(<"$CONVERSATION_FILE")
    response=$(brainbridge --conversation "$conversation_json")
    log DEBUG "Brainbridge response: $response"

    # Make the response editable using editbuf and update the conversation
    log DEBUG "Making brainbridge response editable using editbuf."
    refined_response=$(echo "$response" | xargs editbuf)
    log INFO "Refined response: $refined_response"

    log INFO "Updating conversation with refined response."
    convoupdater "$CONVERSATION_FILE" "assistant" "$refined_response"
  done
  log INFO "Interaction loop ended."
}

# Parse command-line options
while getopts "vhf:" opt; do
  case $opt in
    v) VERBOSITY=$((VERBOSITY+1)) ;;
    h) show_help; exit 0 ;;
    f) CONVERSATION_FILE="$OPTARG" ;;
    *) show_help >&2; exit 1 ;;
  esac
done

# Check for conversation file existence or create it with an empty list
if [ ! -f "$CONVERSATION_FILE" ]; then
  log INFO "Creating a new conversation file."
  echo '[]' > "$CONVERSATION_FILE"
  log INFO "Conversation file initialized at $CONVERSATION_FILE"
else
  log INFO "Using existing conversation file at $CONVERSATION_FILE"
fi

# Start the interaction loop
log INFO "Starting ivim script."
interact
